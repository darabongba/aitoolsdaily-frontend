name: ğŸ¤– aiå·¥å…·æäº¤æ‰“åŒ…éƒ¨ç½²

on:
  #schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è¿è¡Œ (UTC+8 = UTC+0-8)
  #  - cron: '0 1 * * *'
  push:
    branches:
      - main  # å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
      - master # åŒæ—¶æ”¯æŒmasteråˆ†æ”¯

  workflow_dispatch:
    inputs:
      deploy:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ°GitHub Pages'
        required: false
        default: true
        type: boolean

# æƒé™é…ç½®
permissions:
  contents: write
  actions: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“¦ å®‰è£…pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸŸ¢ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pnpm install --no-frozen-lockfile

      - name: ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV

      - name: ğŸ—‚ï¸ åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p cache
          mkdir -p logs


      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯é¡¹ç›®
        run: |          
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºå‰ç«¯é¡¹ç›®..." | tee -a logs/fetch.log
          # æ„å»ºé¡¹ç›®
          pnpm run build
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          if [ -d "dist" ]; then
            echo "âœ… æ„å»ºæˆåŠŸï¼Œäº§ç‰©å¤§å°:" | tee -a logs/fetch.log
            du -sh dist/ | tee -a logs/fetch.log
            ls -la dist/ | tee -a logs/fetch.log
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°distç›®å½•" | tee -a logs/fetch.log
            exit 1
          fi
        env:
          NODE_ENV: production

      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°GitHub Pages..." | tee -a logs/fetch.log
          
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†éƒ¨ç½²å¯†é’¥
          if [ -z "${{ secrets.DEPLOY_TOKEN }}" ]; then
            echo "âš ï¸ æœªé…ç½®DEPLOY_TOKENï¼Œä½¿ç”¨é»˜è®¤DEPLOY_TOKENï¼ˆå¯èƒ½æƒé™ä¸è¶³ï¼‰" | tee -a logs/fetch.log
            DEPLOY_TOKEN="${{ secrets.DEPLOY_TOKEN }}"
          else
            echo "âœ… ä½¿ç”¨é…ç½®çš„DEPLOY_TOKEN" | tee -a logs/fetch.log
            DEPLOY_TOKEN="${{ secrets.DEPLOY_TOKEN }}"
          fi
          
          # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä½¿ç”¨tokenè®¤è¯ï¼‰
          git clone https://${DEPLOY_TOKEN}@github.com/aitoolsdaily/aitoolsdaily.github.io.git pages-repo
          cd pages-repo
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.email "action@github.com"
          git config user.name "GitHub Action Bot"
          
          # æ£€æŸ¥å½“å‰åˆ†æ”¯
          current_branch=$(git branch --show-current)
          echo "ğŸ“‹ å½“å‰åˆ†æ”¯: $current_branch" | tee -a ../logs/fetch.log
          
          # å¦‚æœä¸æ˜¯mainåˆ†æ”¯ï¼Œåˆ‡æ¢åˆ°mainåˆ†æ”¯
          if [ "$current_branch" != "main" ]; then
            git checkout -b main 2>/dev/null || git checkout main
          fi
          
          # æ¸…ç©ºç°æœ‰å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•å’ŒREADME.mdï¼‰
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' ! -name 'README.md' -exec rm -rf {} +
          
          # å¤åˆ¶æ„å»ºäº§ç‰©
          cp -r ../dist/* .
          
          # æ·»åŠ CNAMEæ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦è‡ªå®šä¹‰åŸŸåï¼Œè¯·å–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹åŸŸåï¼‰
           echo "aitools.youseeyou1daydayde.uk" > CNAME
          
                   # æ·»åŠ .nojekyllæ–‡ä»¶ä»¥ç¦ç”¨Jekyllå¤„ç†
           touch .nojekyll
          
           # æ·»åŠ ç®€å•çš„READMEæ–‡ä»¶
           echo "# AI Tools Daily" > README.md
           echo "" >> README.md
           echo "AI Tools Daily - è‡ªåŠ¨éƒ¨ç½²äº $(date '+%Y-%m-%d %H:%M:%S UTC')" >> README.md
           echo "" >> README.md
           echo "è®¿é—®: https://aitools.youseeyou1daydayde.uk" >> README.md
          
          # æäº¤å¹¶å¼ºåˆ¶æ¨é€
          git add .
          
          if git diff --cached --quiet; then
            echo "ğŸ“ æ„å»ºäº§ç‰©æ— å˜åŒ–ï¼Œè·³è¿‡éƒ¨ç½²" | tee -a ../logs/fetch.log
          else          
          
            git commit -m "ğŸš€ è‡ªåŠ¨éƒ¨ç½²AI Tools Daily - $(date '+%Y-%m-%d %H:%M') [skip ci]"
          
            echo "ğŸ“¤ å¼ºåˆ¶æ¨é€åˆ°GitHub Pages..." | tee -a ../logs/fetch.log
            git push --force origin main
          
            echo "âœ… éƒ¨ç½²å®Œæˆ!" | tee -a ../logs/fetch.log
            echo "ğŸŒ è®¿é—®åœ°å€: https://aitools.youseeyou1daydayde.uk" | tee -a ../logs/fetch.log
          fi
          
          cd ..
          rm -rf pages-repo
        env:
          DEPLOY_TOKEN: ${{  secrets.DEPLOY_TOKEN }}

      - name: ğŸ“‹ ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fetch-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7

      - name: ğŸ“Š è¿è¡Œç»“æœæ€»ç»“
        if: always()
        run: |
          echo "=== ğŸš€ Steamæ•°æ®æ›´æ–°å’Œéƒ¨ç½²ä»»åŠ¡å®Œæˆ ===" | tee -a logs/fetch.log
          echo "â° è¿è¡Œæ—¶é—´: $(date)" | tee -a logs/fetch.log
          echo "ğŸ“Š ä»»åŠ¡çŠ¶æ€: ${{ job.status }}" | tee -a logs/fetch.log
          

          
          echo "ğŸ“ æ—¥å¿—æ–‡ä»¶å·²ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©" | tee -a logs/fetch.log
          
          # æ˜¾ç¤ºæœ€åå‡ è¡Œæ—¥å¿—
          echo "=== æœ€è¿‘çš„æ—¥å¿— ===" 
          tail -20 logs/fetch.log